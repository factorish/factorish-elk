#cloud-config

coreos:
  etcd:
      #generate a new token for each unique cluster from https://discovery.etcd.io/new
      <%= @etcd_discovery %>
      addr: $public_ipv4:4001
      peer-addr: $public_ipv4:7001
  units:
    - name: etcd.service
      command: start
    - name: fleet.service
      command: start

write_files:
  - path: /etc/systemd/system/docker.service.d/50-insecure-registry.conf
    content: |
        [Service]
        Environment=DOCKER_OPTS='--insecure-registry="10.0.2.2:5000"'
  - path: /etc/motd
    content: "ELK Demo\n"
  - path: /etc/profile.d/functions.sh
    permissions: '0755'
    content: |
      function start_elasticsearch() {
        eval `cat /etc/environment | sed "s/^/export /"`
        /usr/bin/docker run  -d  -p 9200:9200 -p 9300:9300 -e PUBLISH=9200 \
          -e HOST=$COREOS_PRIVATE_IPV4 --name elasticsearch paulczar/elasticsearch_confd
      }
      function stop_elasticsearch() {
        /usr/bin/docker kill elasticsearch
        /usr/bin/docker rm elasticsearch
      }
      function elasticsearch() {
        /usr/bin/docker exec -it elasticsearch bash
      }
      function start_logstash() {
        eval `cat /etc/environment | sed "s/^/export /"`
        /usr/bin/docker run  -d  -p 514:514 -p 514:514/udp -e PUBLISH=514 \
          -e HOST=$COREOS_PRIVATE_IPV4 --name logstash paulczar/logstash_confd
      }
      function stop_logstash() {
        /usr/bin/docker kill logstash
        /usr/bin/docker rm logstash
      }
      function logstash() {
        /usr/bin/docker exec -it elasticsearch bash
      }
      function start_kibana() {
        eval `cat /etc/environment | sed "s/^/export /"`
        /usr/bin/docker run  -d  -p 5601:5601 -e PUBLISH=5601 \
          -e HOST=$COREOS_PRIVATE_IPV4 --name kibana paulczar/kibana_confd
      }
      function stop_kibana() {
        /usr/bin/docker kill kibana
        /usr/bin/docker rm kibana
      }
      function kibana() {
        /usr/bin/docker exec -it kibana bash
      }
      function cleanup() {
        etcdctl rm --recursive /services
      }
